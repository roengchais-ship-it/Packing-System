<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packing System (Secured)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Work+Sans:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #0f4c75;
            --highlight: #3282b8;
            --light: #f8f9fa;
            --border: #e0e0e0;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --text: #2c3e50;
            --text-light: #7f8c8d;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Work Sans', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary);
            z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 3rem; border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center;
            width: 400px; max-width: 90%; animation: slideUp 0.5s ease;
        }
        .login-title { font-family: 'Space Mono', monospace; font-size: 2rem; margin-bottom: 1rem; color: var(--primary); font-weight: bold; }
        .login-input { 
            width: 100%; padding: 1rem; font-size: 1.5rem; text-align: center; 
            letter-spacing: 5px; margin-bottom: 1.5rem; border: 2px solid var(--border); 
            border-radius: 8px; font-family: 'Space Mono', monospace;
        }
        .login-btn { 
            width: 100%; padding: 1rem; background: var(--accent); color: white; 
            border: none; font-size: 1.2rem; border-radius: 8px; cursor: pointer; 
            font-weight: bold; transition: 0.2s; font-family: 'Work Sans', sans-serif;
        }
        .login-btn:hover { background: var(--highlight); }
        .login-hint { margin-top: 2rem; font-size: 0.8rem; color: #aaa; line-height: 1.6; }
        
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; display: none; }
        
        header {
            background: var(--primary);
            color: white;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 32px var(--shadow);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        header h1 {
            font-family: 'Space Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -1px;
            margin-bottom: 0.5rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;
            font-size: 0.9rem; transition: 0.3s;
        }
        .logout-btn:hover { background: var(--danger); border-color: var(--danger); }
        
        .tab-navigation {
            display: flex; gap: 1rem; margin-bottom: 2rem;
            background: white; padding: 1rem; border-radius: 12px;
            box-shadow: 0 4px 16px var(--shadow);
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 0.875rem 2rem; border: none; background: var(--light);
            color: var(--text); font-family: 'Work Sans', sans-serif;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            border-radius: 8px; transition: all 0.3s ease;
        }
        
        .tab-btn:hover { background: var(--accent); color: white; transform: translateY(-2px); }
        .tab-btn.active { background: var(--accent); color: white; box-shadow: 0 4px 12px rgba(15, 76, 117, 0.3); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card {
            background: white; padding: 2rem; border-radius: 12px;
            box-shadow: 0 4px 16px var(--shadow); margin-bottom: 2rem;
        }
        
        .card-title {
            font-family: 'Space Mono', monospace; font-size: 1.5rem;
            font-weight: 700; color: var(--primary); margin-bottom: 1.5rem;
            padding-bottom: 1rem; border-bottom: 3px solid var(--accent);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .form-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }
        
        .form-group { display: flex; flex-direction: column; margin-bottom: 1rem; }
        .form-group label { font-weight: 600; margin-bottom: 0.5rem; color: var(--text); font-size: 0.9rem; }
        
        .form-group input, .form-group select, .form-group textarea {
            padding: 0.875rem; border: 2px solid var(--border); border-radius: 8px;
            font-family: 'Work Sans', sans-serif; font-size: 1rem; transition: all 0.3s ease;
        }
        
        .form-group textarea { resize: vertical; min-height: 100px; font-family: 'Space Mono', monospace; }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(15, 76, 117, 0.1);
        }
        
        .product-table, .queue-table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; overflow-x: auto; }
        
        .product-table th, .queue-table th {
            background: var(--secondary); color: white; padding: 1rem;
            text-align: left; font-weight: 600; font-size: 0.9rem;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        
        .product-table td, .queue-table td { padding: 0.875rem; border-bottom: 1px solid var(--border); }
        
        .product-table input, .product-table select {
            width: 100%; padding: 0.625rem; border: 2px solid var(--border);
            border-radius: 6px; font-family: 'Work Sans', sans-serif;
        }
        
        .product-table .calculated {
            background: #e8f4f8; font-weight: 700; color: var(--accent);
            text-align: center; font-family: 'Space Mono', monospace; font-size: 1.1rem;
            transition: background 0.3s ease;
        }
        
        .btn {
            padding: 1rem 2rem; border: none; border-radius: 8px;
            font-family: 'Work Sans', sans-serif; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: all 0.3s ease; display: inline-flex;
            align-items: center; justify-content: center; gap: 0.5rem;
        }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px var(--shadow); }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--highlight); }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: var(--light); color: var(--text); border: 2px solid var(--border); }
        .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.85rem; border-radius: 4px; }
        
        .btn-group { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 2rem; }
        
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }
        .stat-card {
            background: white; padding: 1.5rem; border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow); display: flex; align-items: center;
            gap: 1rem; border-left: 5px solid var(--accent);
        }
        .stat-icon {
            background: #f0f4f8; width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
        }
        .stat-info h3 { font-size: 1.8rem; font-weight: 700; color: var(--primary); margin: 0; line-height: 1; }
        .stat-info p { font-size: 0.9rem; color: var(--text-light); margin: 0.2rem 0 0 0; }
        
        .filter-chips { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
        .filter-chip {
            padding: 0.5rem 1rem; background: white; border: 1px solid var(--border);
            border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s;
        }
        .filter-chip:hover { background: #f0f0f0; }
        .filter-chip.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .record-table { width: 100%; border-collapse: collapse; overflow-x: auto; display: block; }
        .record-table thead, .record-table tbody, .record-table tr { display: table; width: 100%; table-layout: fixed; }
        .record-table tbody { display: block; max-height: 600px; overflow-y: auto; }
        .record-table th { position: sticky; top: 0; z-index: 10; background: var(--secondary); color: white; padding: 1rem; text-align: left; }
        .record-table td { padding: 0.875rem; border-bottom: 1px solid var(--border); }
        
        .order-row { cursor: pointer; transition: background 0.2s; }
        .order-row:hover { background: #f8f9fa; }
        .order-row.expanded { background: #eef2f7; border-left: 4px solid var(--accent); }
        
        .progress-bar { width: 100px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; display: inline-block; vertical-align: middle; margin-right: 0.5rem; }
        .progress-fill { height: 100%; background: var(--success); transition: width 0.3s ease; }
        
        .order-details-row { display: none; background: #fcfcfc; }
        .order-details-row.active { display: table-row; }
        .nested-table { width: 95%; margin: 1rem auto; border: 1px solid #ddd; background: white; }
        .nested-table th { background: #eee; color: #333; font-size: 0.8rem; padding: 0.5rem; }
        .nested-table td { font-size: 0.85rem; padding: 0.5rem; border-bottom: 1px solid #eee; }

        .status-badge { padding: 0.375rem 0.875rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; display: inline-block; }
        .status-packed { background: #d4edda; color: #155724; }
        .status-updated { background: #fff3cd; color: #856404; }
        .status-locked { background: #f8d7da; color: #721c24; }
        
        .action-btns { display: flex; gap: 0.5rem; }
        .action-btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.3s ease; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; animation: fadeIn 0.3s ease; }
        .modal.active { display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; animation: slideUp 0.3s ease; }
        .modal-header { font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--primary); }
        
        .role-selector { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .role-btn { padding: 0.875rem 1.5rem; border: 2px solid var(--border); background: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
        .role-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        .queue-badge { background: var(--danger); color: white; padding: 0.2rem 0.6rem; border-radius: 50%; font-size: 0.8rem; margin-left: 0.5rem; display: none; }
        
        .empty-state { text-align: center; padding: 3rem; color: var(--text-light); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
        .empty-state-text { font-size: 1.1rem; }

        .record-filters { display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; }
        
        @media print {
            body { background: white; margin: 0; padding: 0; }
            #login-overlay, .container, header, .tab-navigation, .btn, .card, .modal { display: none !important; }
            .print-label { display: block !important; page-break-after: always; width: 210mm; height: 297mm; padding: 20mm; margin: 0; box-sizing: border-box; position: relative; }
            .print-label:last-child { page-break-after: auto; }
            .packing-list { display: block !important; }
            .packing-list-print { padding: 15mm; }
            .packing-list-page { page-break-after: always; height: 277mm; position: relative; }
            .packing-list-page:last-child { page-break-after: auto; }
        }
        
        .print-label, .packing-list { display: none; }
        .print-label { background: white; border: 3px solid #000; padding: 2rem; }
        
        .label-header { border-bottom: 4px solid #000; padding-bottom: 1.5rem; margin-bottom: 2rem; }
        .label-title { font-family: 'Space Mono', monospace; font-size: 2rem; font-weight: 700; color: #000; }
        .label-customer-highlight { font-size: 3rem; font-weight: 700; text-transform: uppercase; color: #000; text-align: center; margin: 1.5rem 0 2rem 0; padding: 1rem; border: 4px solid #000; }
        .label-info { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 1rem; color: #000; }
        .label-product { background: white; color: #000; padding: 2rem; border: 3px solid #000; border-radius: 8px; margin: 2rem 0; text-align: center; }
        .label-product-name { font-family: 'Space Mono', monospace; font-size: 3rem; font-weight: 700; margin-bottom: 1rem; line-height: 1.2; }
        .label-quantity { font-size: 2rem; font-weight: 600; }
        
        .label-lot { background: white; padding: 2rem; border: 3px dashed #000; border-radius: 8px; margin: 2rem 0; min-height: 150px; display: flex; flex-direction: column; justify-content: center; }
        .label-lot-title { font-family: 'Space Mono', monospace; font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: #000; text-align: left; }
        
        .label-lot-content { 
            font-family: 'Space Mono', monospace; 
            font-size: 2rem; 
            font-weight: 700; 
            text-align: center; 
            color: #000;
            white-space: pre-wrap;
        }
        
        .label-lot-content.mixed-lot {
            font-size: 1.25rem;
            text-align: left;
            line-height: 1.4;
        }

        .label-signatures { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 3rem; }
        .label-signature { border-top: 2px solid #000; padding-top: 0.5rem; color: #000; }
        .label-remarks { margin-top: 2rem; padding: 1rem; background: white; border: 2px solid #000; border-radius: 8px; color: #000; }

        .packing-list-print { background: white; padding: 2rem; font-family: 'Work Sans', sans-serif; color: #000; }
        .packing-list-header { border-bottom: 3px solid #000; margin-bottom: 2rem; padding-bottom: 1rem; }
        .packing-list-title { font-family: 'Space Mono', monospace; font-size: 2rem; font-weight: 700; color: #000; margin-bottom: 1rem; }
        .packing-list-info { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 1rem; color: #000; }
        .packing-list-table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; }
        .packing-list-table th, .packing-list-table td { border: 1px solid #000; padding: 0.75rem; color: #000; font-size: 0.9rem; vertical-align: top; }
        .packing-list-table th { background: #f0f0f0; }
        .packing-list-sku-header { background: #000; color: white; padding: 0.75rem 1rem; font-family: 'Space Mono', monospace; font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; }
        
        .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; }
        .alert.active { display: block; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 class="login-title">üîê WMS LOGIN</h2>
            <input type="password" id="accessCode" class="login-input" placeholder="****" maxlength="4" onkeypress="if(event.key==='Enter') login()">
            <button class="login-btn" onclick="login()">ACCESS SYSTEM</button>
            <div class="login-hint">
                <p><strong>Packing:</strong> 3333 | <strong>Store:</strong> 1111</p>
                <p><strong>QC:</strong> 2222 | <strong>Manager:</strong> 9999</p>
            </div>
        </div>
    </div>

    <div class="container" id="mainApp">
        <header>
            <div>
                <h1>üì¶ Packing & Label System</h1>
                <p style="font-size: 0.9rem; opacity: 0.8;" id="userRoleDisplay">Retail & B2B Delivery Management</p>
            </div>
            <button class="logout-btn" onclick="location.reload()">üîí Logout</button>
        </header>
        
        <div class="card" id="navCard" style="display:none;">
            <div class="role-selector">
                <div class="role-btn active" id="btn-packing" onclick="setRole('packing')">üë∑ Packing Staff</div>
                <div class="role-btn" id="btn-supervisor" onclick="setRole('supervisor')">üë®‚Äçüíº Manager</div>
                <div class="role-btn" id="btn-qc" onclick="setRole('qc')">üîç QC Staff</div>
            </div>
        </div>
        
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('packing')">üìù Packing Entry</button>
            <button class="tab-btn" onclick="switchTab('records')">üìã Records & History</button>
            <button class="tab-btn" onclick="switchTab('labels')">üè∑Ô∏è Generated Labels <span id="queue-badge-tab" class="queue-badge">0</span></button>
            <button class="tab-btn" onclick="switchTab('withdrawal')">üì§ Orders Ready for Withdrawal <span id="withdrawal-badge" class="queue-badge">0</span></button>
            <button class="tab-btn" onclick="switchTab('qc-inspection')">üîç QC Inspection <span id="qc-badge" class="queue-badge">0</span></button>
            <button class="tab-btn" onclick="switchTab('stock-rework')">üîß Stock Rework <span id="rework-badge" class="queue-badge">0</span></button>
            <button class="tab-btn" onclick="switchTab('ready-ship')">üöö Ready to Ship <span id="ship-badge" class="queue-badge">0</span></button>
            <button class="tab-btn" onclick="switchTab('packing-list')">üìÑ Packing List PDF</button>
        </div>
        
        <div id="packing-tab" class="tab-content active">
            <div class="card">
                <h2 class="card-title">Order Information</h2>
                <div class="form-grid">
                    <div class="form-group"><label for="orderNumber">Order Number *</label><input type="text" id="orderNumber" placeholder="e.g., ORD-2024-001" required></div>
                    <div class="form-group"><label for="customerName">Customer Name *</label><input type="text" id="customerName" placeholder="e.g., ABC Company Ltd." required></div>
                    <div class="form-group"><label for="deliveryLocation">Delivery Location *</label><input type="text" id="deliveryLocation" placeholder="e.g., Bangkok Warehouse" required></div>
                    <div class="form-group"><label for="packingDate">Packing Date</label><input type="date" id="packingDate" required></div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">Product Details</h2>
                <div style="overflow-x: auto;">
                    <table class="product-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">#</th>
                                <th style="width: 25%;">Product Name *</th>
                                <th style="width: 15%;">Qty per Box *</th>
                                <th style="width: 15%;">Total Qty *</th>
                                <th style="width: 15%;">Boxes</th>
                                <th style="width: 20%;">Remarks</th>
                                <th style="width: 5%;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                            <tr data-row="1">
                                <td>1</td>
                                <td><input type="text" class="product-name" placeholder="Product name" required></td>
                                <td><input type="number" class="qty-per-box" min="1" placeholder="10" oninput="calculateBoxes(1)" required></td>
                                <td><input type="number" class="total-qty" min="1" placeholder="100" oninput="calculateBoxes(1)" required></td>
                                <td class="calculated"><span class="box-count">0</span></td>
                                <td><input type="text" class="remarks" placeholder="Optional"></td>
                                <td><button class="btn-danger action-btn" onclick="removeRow(1)">‚úï</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="btn-group"><button class="btn btn-secondary" onclick="addProductRow()">‚ûï Add Product Row</button></div>
            </div>

            <div class="btn-group">
                <button class="btn btn-warning" onclick="addToQueue()" style="flex: 2; border: 2px solid var(--warning);">‚¨áÔ∏è Add Order to Queue (Draft)</button>
                <button class="btn btn-secondary" onclick="clearFormInputs()" style="flex: 1;">üîÑ Clear Form Inputs</button>
            </div>
            
            <div class="card" style="margin-top: 2rem; border: 2px solid var(--accent);">
                <h2 class="card-title">üìã Packing Queue <span id="queue-count" style="font-size: 0.9rem; background: var(--secondary); color: white; padding: 0.2rem 0.8rem; border-radius: 20px;">0 Orders</span></h2>
                <div style="overflow-x: auto;">
                    <table class="queue-table">
                        <thead><tr><th>Order #</th><th>Customer</th><th>Products</th><th>Total Boxes</th><th>Actions</th></tr></thead>
                        <tbody id="queueTableBody"></tbody>
                    </table>
                </div>
                <div id="empty-queue" class="empty-state" style="padding: 2rem;"><div style="font-size: 2rem; margin-bottom: 0.5rem;">üì•</div><div>Queue is empty. Add orders above.</div></div>
                <div class="btn-group" id="generate-actions" style="display: none; border-top: 1px solid var(--border); padding-top: 1.5rem;">
                    <button class="btn btn-primary" onclick="generateAllLabels()" style="width: 100%; justify-content: center; font-size: 1.2rem; padding: 1.5rem;">üè∑Ô∏è Generate ALL Labels in Queue</button>
                </div>
            </div>
            <div id="alert-container"></div>
        </div>
        
        <div id="records-tab" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card" style="border-left-color: var(--highlight);"><div class="stat-icon">üì¶</div><div class="stat-info"><h3 id="stat-total-orders">0</h3><p>Orders Today</p></div></div>
                <div class="stat-card" style="border-left-color: var(--success);"><div class="stat-icon">‚úÖ</div><div class="stat-info"><h3 id="stat-completed">0</h3><p>Completed (QC)</p></div></div>
                <div class="stat-card" style="border-left-color: var(--warning);"><div class="stat-icon">‚è≥</div><div class="stat-info"><h3 id="stat-pending">0</h3><p>In Progress</p></div></div>
            </div>

            <div class="card">
                <h2 class="card-title">History & Management</h2>
                <div class="record-filters">
                    <input type="text" id="mainSearch" placeholder="üîç Search Order, Customer, Product..." onkeyup="renderOrderList()" style="width: 300px; padding: 0.5rem;">
                    <input type="date" id="dateFilter" onchange="renderOrderList()" style="padding: 0.5rem;">
                </div>
                <div class="filter-chips">
                    <div class="filter-chip active" onclick="setFilter('all', this)">All Orders</div>
                    <div class="filter-chip" onclick="setFilter('today', this)">üìÖ Today</div>
                    <div class="filter-chip" onclick="setFilter('incomplete', this)">‚ö†Ô∏è Incomplete / No LOT</div>
                    <div class="filter-chip" onclick="setFilter('locked', this)">üîí QC Locked</div>
                </div>
                <div class="btn-group" style="margin-top: 1rem; margin-bottom: 2rem;">
                     <button class="btn btn-success" onclick="exportToExcel()">üìä Export All Data</button>
                     <button class="btn btn-secondary" onclick="clearAllFilters()">üîÑ Reset View</button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="record-table">
                        <thead><tr><th style="width: 5%;"></th><th style="width: 15%;">Order Number</th><th style="width: 20%;">Customer</th><th style="width: 15%;">Packing Date</th><th style="width: 15%;">Progress</th><th style="width: 15%;">Status</th><th style="width: 15%;">Actions</th></tr></thead>
                        <tbody id="orderListBody"></tbody>
                    </table>
                </div>
                <div id="empty-history" class="empty-state"><div class="empty-state-icon">üì≠</div><div class="empty-state-text">No records found</div></div>
            </div>
        </div>
        
        <div id="labels-tab" class="tab-content">
            <div class="card">
                <h2 class="card-title">Generated Labels</h2>
                <div id="label-preview-container">
                    <div class="empty-state"><div class="empty-state-icon">üè∑Ô∏è</div><div class="empty-state-text">No labels generated yet</div></div>
                </div>
                <div class="btn-group" id="label-actions" style="display: none;">
                    <button class="btn btn-primary" onclick="printAllLabels()">üñ®Ô∏è Print All Labels</button>
                </div>
            </div>
        </div>
        
        <div id="withdrawal-tab" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card" style="border-left-color: var(--success);"><div class="stat-icon">üì¶</div><div class="stat-info"><h3 id="stat-ready-orders">0</h3><p>Ready Orders</p></div></div>
                <div class="stat-card" style="border-left-color: var(--highlight);"><div class="stat-icon">üì§</div><div class="stat-info"><h3 id="stat-ready-boxes">0</h3><p>Total Boxes</p></div></div>
                <div class="stat-card" style="border-left-color: var(--warning);"><div class="stat-icon">‚è±Ô∏è</div><div class="stat-info"><h3 id="stat-oldest-days">0</h3><p>Oldest (Days)</p></div></div>
            </div>

            <div class="card">
                <h2 class="card-title">Orders Ready for Withdrawal (Auto-moved from Packing)</h2>
                <div class="record-filters">
                    <input type="text" id="withdrawalSearch" placeholder="üîç Search Order or Customer..." onkeyup="renderWithdrawalList()" style="width: 300px; padding: 0.5rem; margin-right: 1rem;">
                    <select id="withdrawalSortBy" onchange="renderWithdrawalList()" style="padding: 0.5rem;">
                        <option value="date-desc">Date (Newest First)</option>
                        <option value="date-asc">Date (Oldest First)</option>
                        <option value="customer">Customer A-Z</option>
                        <option value="boxes-desc">Most Boxes</option>
                    </select>
                </div>
                <div style="overflow-x: auto;">
                    <table class="record-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;"></th>
                                <th style="width: 12%;">Order Number</th>
                                <th style="width: 15%;">Customer</th>
                                <th style="width: 12%;">Location</th>
                                <th style="width: 10%;">Packing Date</th>
                                <th style="width: 8%;">Total Items</th>
                                <th style="width: 10%;">Days Waiting</th>
                                <th style="width: 12%;">Status</th>
                                <th style="width: 16%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalListBody"></tbody>
                    </table>
                </div>
                <div id="empty-withdrawal" class="empty-state" style="padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                    <div style="font-size: 1.2rem; font-weight: 600;">No orders ready for withdrawal</div>
                    <div style="color: var(--text-light); margin-top: 0.5rem;">Orders from Packing will appear here automatically</div>
                </div>
            </div>
        </div>

        <div id="qc-inspection-tab" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card" style="border-left-color: var(--warning);"><div class="stat-icon">‚è≥</div><div class="stat-info"><h3 id="stat-qc-pending">0</h3><p>Pending QC</p></div></div>
                <div class="stat-card" style="border-left-color: var(--success);"><div class="stat-icon">‚úÖ</div><div class="stat-info"><h3 id="stat-qc-passed">0</h3><p>QC Passed</p></div></div>
                <div class="stat-card" style="border-left-color: var(--danger);"><div class="stat-icon">‚ùå</div><div class="stat-info"><h3 id="stat-qc-failed">0</h3><p>QC Failed</p></div></div>
            </div>
            <div class="card">
                <h2 class="card-title">QC Inspection Queue</h2>
                <div style="overflow-x: auto;">
                    <table class="record-table">
                        <thead><tr><th style="width:5%;"></th><th>Order #</th><th>Customer</th><th>Items</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="qcListBody"></tbody>
                    </table>
                </div>
                <div id="empty-qc" class="empty-state"><div class="empty-state-icon">üîç</div><div class="empty-state-text">No orders waiting for QC</div></div>
            </div>
        </div>

        <div id="stock-rework-tab" class="tab-content">
            <div class="card">
                <h2 class="card-title">Stock Rework - QC Failed Items</h2>
                <div style="overflow-x: auto;">
                    <table class="record-table">
                        <thead><tr><th style="width:5%;"></th><th>Order #</th><th>Customer</th><th>Failed Items</th><th>Actions</th></tr></thead>
                        <tbody id="reworkListBody"></tbody>
                    </table>
                </div>
                <div id="empty-rework" class="empty-state"><div class="empty-state-icon">üîß</div><div class="empty-state-text">No items need rework</div></div>
            </div>
        </div>

        <div id="ready-ship-tab" class="tab-content">
            <div class="card">
                <h2 class="card-title">Ready to Ship</h2>
                <div style="overflow-x: auto;">
                    <table class="record-table">
                        <thead><tr><th style="width:5%;"></th><th>Order #</th><th>Customer</th><th>Total Items</th><th>Ship Date</th><th>Actions</th></tr></thead>
                        <tbody id="shipListBody"></tbody>
                    </table>
                </div>
                <div id="empty-ship" class="empty-state"><div class="empty-state-icon">üöö</div><div class="empty-state-text">No orders ready to ship</div></div>
            </div>
        </div>
        
        <div id="packing-list-tab" class="tab-content">
            <div class="card">
                <h2 class="card-title">Generate Packing List PDF</h2>
                <div class="form-group" style="max-width: 400px;">
                    <label for="packingListOrderNumber">Select Order Number *</label>
                    <select id="packingListOrderNumber" style="padding: 0.875rem; border: 2px solid var(--border); border-radius: 8px;">
                        <option value="">-- Select Order --</option>
                    </select>
                </div>
                <div class="btn-group"><button class="btn btn-primary" onclick="generatePackingListPDF()">üìÑ Generate Packing List PDF</button></div>
            </div>
            <div class="card" id="packing-list-preview" style="display: none;">
                <h2 class="card-title">Packing List Preview</h2>
                <div id="packing-list-content"></div>
                <div class="btn-group"><button class="btn btn-primary" onclick="printPackingList()">üñ®Ô∏è Print Packing List</button></div>
            </div>
        </div>
    </div>
    
    <div id="editLotModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header">Edit LOT Number(s)</h3>
            <div class="form-group"><label>Product Name:</label><input type="text" id="modalProductName" readonly style="background: #f0f0f0;"></div>
            <div class="form-group">
                <label>LOT Number(s):</label>
                <textarea id="modalLotNumber" rows="5" placeholder="Enter LOT Number(s)"></textarea>
                <small style="color: var(--text-light);">* Press Enter for new line to separate multiple LOTs</small>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="saveLotNumber()">üíæ Save</button>
                <button class="btn btn-secondary" onclick="closeModal()">‚úï Cancel</button>
            </div>
        </div>
    </div>

    <div id="editBoxModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header" id="editModalTitle">Edit Box Details</h3>
            <div class="alert alert-warning" id="retroactiveWarning" style="display:none">
                <strong>‚ö†Ô∏è Warning:</strong> You are editing a record retrospectively. This action will be logged.
            </div>
            <div class="form-group"><label>Product Name:</label><input type="text" id="editModalProductName"></div>
            <div class="form-group"><label>Quantity in Box:</label><input type="number" id="editModalQty" min="1"></div>
            <div class="form-group"><label>LOT Number(s):</label><textarea id="editModalLotNumber" rows="3" placeholder="Enter LOT Number(s)"></textarea></div>
            <div class="form-group"><label>Remarks:</label><input type="text" id="editModalRemarks" placeholder="Optional remarks"></div>
            <hr style="border:0; border-top:1px solid #eee; margin: 1rem 0;">
            <div class="form-group" id="editReasonGroup" style="display:none;">
                <label style="color: var(--danger);">Reason for Edit (Required)*:</label>
                <textarea id="editModalReason" rows="2" placeholder="e.g. Keyed wrong number, Counted error..."></textarea>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="saveBoxEdit()">üíæ Save Changes</button>
                <button class="btn btn-secondary" onclick="closeEditBoxModal()">‚úï Cancel</button>
            </div>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header">Confirm Delete</h3>
            <p id="deleteConfirmMessage" style="margin: 1rem 0; font-size: 1.1rem;"></p>
            <div class="btn-group">
                <button class="btn btn-danger" onclick="confirmDelete()">üóëÔ∏è Delete</button>
                <button class="btn btn-secondary" onclick="closeDeleteModal()">‚úï Cancel</button>
            </div>
        </div>
    </div>

    <div id="withdrawalModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 class="modal-header">üì§ Complete Withdrawal</h3>
            <div id="withdrawalOrderInfo" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;"></div>
            <div class="form-group">
                <label>Withdrawn By (Name) *</label>
                <input type="text" id="withdrawnBy" placeholder="Enter name" style="padding: 0.875rem; border: 2px solid var(--border); border-radius: 8px; width: 100%;">
            </div>
            <div class="form-group">
                <label>Withdrawal Date *</label>
                <input type="date" id="withdrawalDate" style="padding: 0.875rem; border: 2px solid var(--border); border-radius: 8px; width: 100%;">
            </div>
            <div class="form-group">
                <label>Withdrawal Time *</label>
                <input type="time" id="withdrawalTime" style="padding: 0.875rem; border: 2px solid var(--border); border-radius: 8px; width: 100%;">
            </div>
            <div class="form-group">
                <label>Notes (Optional)</label>
                <textarea id="withdrawalNotes" rows="3" placeholder="Any special notes..." style="padding: 0.875rem; border: 2px solid var(--border); border-radius: 8px; width: 100%; resize: vertical;"></textarea>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="confirmWithdrawal()">‚úÖ Complete Withdrawal</button>
                <button class="btn btn-secondary" onclick="closeWithdrawalModal()">‚úï Cancel</button>
            </div>
        </div>
    </div>

    <div id="stockEditModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h3 class="modal-header">üì¶ Stock Adjustment</h3>
            <div id="stockEditOrderInfo" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;"></div>
            <div id="stockEditItems" style="max-height: 400px; overflow-y: auto;"></div>
            <div class="btn-group" style="margin-top: 1.5rem;">
                <button class="btn btn-success" onclick="submitStockAdjustment()">‚úÖ Confirm & Send to QC</button>
                <button class="btn btn-secondary" onclick="closeStockEditModal()">‚úï Cancel</button>
            </div>
        </div>
    </div>

    <div id="qcInspectionModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h3 class="modal-header">üîç QC Inspection</h3>
            <div id="qcInspectionOrderInfo" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;"></div>
            <div id="qcInspectionItems" style="max-height: 450px; overflow-y: auto;"></div>
            <div class="btn-group" style="margin-top: 1.5rem;">
                <button class="btn btn-success" onclick="submitQCInspection()">‚úÖ Complete QC Inspection</button>
                <button class="btn btn-secondary" onclick="closeQCInspectionModal()">‚úï Cancel</button>
            </div>
        </div>
    </div>

    <div id="stockReworkModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h3 class="modal-header">üîß Stock Rework</h3>
            <div id="reworkOrderInfo" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;"></div>
            <div id="reworkItems" style="max-height: 400px; overflow-y: auto;"></div>
            <div class="btn-group" style="margin-top: 1.5rem;">
                <button class="btn btn-success" onclick="submitRework()">‚úÖ Send Back to QC</button>
                <button class="btn btn-secondary" onclick="closeReworkModal()">‚úï Cancel</button>
            </div>
        </div>
    </div>

    <div id="print-labels-container"></div>
    <div id="packing-list-print-container" class="packing-list"></div>

    <script>
        let boxRecords = [];
        let packingQueue = [];
        let rowCounter = 1;
        let currentUserRole = 'packing';
        let currentEditingBoxId = null;
        let deleteTarget = null;
        let currentFilterType = 'all'; 
        let currentEditType = 'assign';
        let currentWithdrawalOrder = null;
        let currentStockEditOrder = null;
        let currentQCInspectionOrder = null;
        let currentReworkOrder = null;
        
        const USERS = {
            '1111': 'store',
            '2222': 'qc',
            '3333': 'packing',
            '9999': 'supervisor'
        };

        function login() {
            const code = document.getElementById('accessCode').value;
            if (USERS[code]) {
                const role = USERS[code];
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                setUserRole(role);
                
                if (role !== 'supervisor') {
                    document.getElementById('navCard').style.display = 'none';
                } else {
                    document.getElementById('navCard').style.display = 'block';
                }
                
                document.getElementById('userRoleDisplay').innerText = `Logged in as: ${role.toUpperCase()}`;
            } else {
                alert("Incorrect Access Code");
                document.getElementById('accessCode').value = '';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('packingDate').valueAsDate = new Date();
            loadRecordsFromStorage();
            renderRecords(); 
            renderQueue();
            populateOrderNumberDropdown();
        });

        function calculateBoxes(rowNum) {
            const row = document.querySelector(`tr[data-row="${rowNum}"]`);
            if (!row) return;
            const qtyPerBox = parseFloat(row.querySelector('.qty-per-box').value) || 0;
            const totalQty = parseFloat(row.querySelector('.total-qty').value) || 0;
            const boxDisplay = row.querySelector('.box-count');
            if (qtyPerBox > 0 && totalQty > 0) {
                const boxes = Math.ceil(totalQty / qtyPerBox);
                boxDisplay.textContent = boxes;
                boxDisplay.parentElement.style.backgroundColor = '#d1e7dd';
                setTimeout(() => { boxDisplay.parentElement.style.backgroundColor = '#e8f4f8'; }, 300);
            } else {
                boxDisplay.textContent = '0';
            }
        }

        function addProductRow() {
            rowCounter++;
            const tbody = document.getElementById('productTableBody');
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-row', rowCounter);
            newRow.innerHTML = `
                <td>${rowCounter}</td>
                <td><input type="text" class="product-name" placeholder="Product name" required></td>
                <td><input type="number" class="qty-per-box" min="1" placeholder="10" oninput="calculateBoxes(${rowCounter})" required></td>
                <td><input type="number" class="total-qty" min="1" placeholder="100" oninput="calculateBoxes(${rowCounter})" required></td>
                <td class="calculated"><span class="box-count">0</span></td>
                <td><input type="text" class="remarks" placeholder="Optional"></td>
                <td><button class="btn-danger action-btn" onclick="removeRow(${rowCounter})">‚úï</button></td>
            `;
            tbody.appendChild(newRow);
        }

        function removeRow(rowNum) {
            const row = document.querySelector(`tr[data-row="${rowNum}"]`);
            if (row && document.querySelectorAll('#productTableBody tr').length > 1) {
                row.remove();
            } else {
                showAlert('Cannot remove the last row', 'error');
            }
        }

        function resetProductTable() {
            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = '';
            rowCounter = 1;
            addProductRow();
        }

        function setUserRole(role) {
            currentUserRole = role;
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            const buttons = document.querySelectorAll('.role-btn');
            buttons.forEach(btn => {
                if(btn.getAttribute('onclick').includes(role)) {
                    btn.classList.add('active');
                }
            });
            renderRecords();
        }

        function setRole(role) {
            setUserRole(role);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            if (tabName === 'records') renderRecords();
            if (tabName === 'withdrawal') renderWithdrawalList();
            if (tabName === 'qc-inspection') renderQCInspectionList();
            if (tabName === 'stock-rework') renderStockReworkList();
            if (tabName === 'ready-ship') renderReadyToShipList();
            if (tabName === 'packing-list') populateOrderNumberDropdown();
        }

        function addToQueue() {
            const orderNumber = document.getElementById('orderNumber').value.trim();
            const customerName = document.getElementById('customerName').value.trim();
            const deliveryLocation = document.getElementById('deliveryLocation').value.trim();
            const packingDate = document.getElementById('packingDate').value;

            if (!orderNumber || !customerName || !deliveryLocation || !packingDate) {
                showAlert('Please fill in all order information fields', 'error');
                return;
            }

            const existingInQueue = packingQueue.find(q => q.orderNumber === orderNumber);
            if (existingInQueue) { showAlert('Order Number already in queue.', 'error'); return; }

            const rows = document.querySelectorAll('#productTableBody tr');
            let hasProducts = false;
            let totalBoxes = 0;
            const productData = [];

            rows.forEach(row => {
                const productName = row.querySelector('.product-name').value.trim();
                const qtyPerBox = parseInt(row.querySelector('.qty-per-box').value) || 0;
                const totalQty = parseInt(row.querySelector('.total-qty').value) || 0;
                const remarks = row.querySelector('.remarks').value.trim();
                const boxes = parseInt(row.querySelector('.box-count').textContent) || 0;

                if (productName && qtyPerBox > 0 && totalQty > 0 && boxes > 0) {
                    hasProducts = true;
                    totalBoxes += boxes;
                    productData.push({ productName, qtyPerBox, totalQty, boxes, remarks });
                }
            });

            if (!hasProducts) { showAlert('Please add at least one valid product', 'error'); return; }

            packingQueue.push({ id: Date.now(), orderNumber, customerName, deliveryLocation, packingDate, products: productData, totalBoxes });
            saveQueueToStorage();
            renderQueue();
            
            document.getElementById('orderNumber').value = '';
            document.getElementById('customerName').value = '';
            resetProductTable();
            showAlert('Order added to queue!', 'success');
        }

        function renderQueue() {
            const tbody = document.getElementById('queueTableBody');
            const emptyState = document.getElementById('empty-queue');
            const actionDiv = document.getElementById('generate-actions');
            const countSpan = document.getElementById('queue-count');
            const badgeTab = document.getElementById('queue-badge-tab');

            tbody.innerHTML = '';
            countSpan.textContent = `${packingQueue.length} Orders`;
            if(badgeTab) {
                badgeTab.textContent = packingQueue.length;
                badgeTab.style.display = packingQueue.length > 0 ? 'inline-block' : 'none';
            }

            if (packingQueue.length === 0) {
                emptyState.style.display = 'block'; actionDiv.style.display = 'none'; return;
            }
            emptyState.style.display = 'none'; actionDiv.style.display = 'flex';

            packingQueue.forEach((item, index) => {
                const row = document.createElement('tr');
                const productSummary = item.products.map(p => `${p.productName} (${p.boxes})`).join(', ');
                row.innerHTML = `
                    <td><strong>${item.orderNumber}</strong></td>
                    <td>${item.customerName}</td>
                    <td><div style="font-size: 0.85rem;">${productSummary}</div></td>
                    <td style="text-align: center; font-weight: bold;">${item.totalBoxes}</td>
                    <td><div class="action-btns"><button class="action-btn btn-warning" onclick="editQueueItem(${index})">‚úèÔ∏è Edit</button><button class="action-btn btn-danger" onclick="deleteQueueItem(${index})">‚úï</button></div></td>
                `;
                tbody.appendChild(row);
            });
        }

        function editQueueItem(index) {
            const item = packingQueue[index];
            document.getElementById('orderNumber').value = item.orderNumber;
            document.getElementById('customerName').value = item.customerName;
            document.getElementById('deliveryLocation').value = item.deliveryLocation;
            document.getElementById('packingDate').value = item.packingDate;

            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = '';
            rowCounter = 0;

            item.products.forEach(prod => {
                rowCounter++;
                const newRow = document.createElement('tr');
                newRow.setAttribute('data-row', rowCounter);
                newRow.innerHTML = `
                    <td>${rowCounter}</td>
                    <td><input type="text" class="product-name" value="${prod.productName}" placeholder="Product name" required></td>
                    <td><input type="number" class="qty-per-box" value="${prod.qtyPerBox}" min="1" oninput="calculateBoxes(${rowCounter})" required></td>
                    <td><input type="number" class="total-qty" value="${prod.totalQty}" min="1" oninput="calculateBoxes(${rowCounter})" required></td>
                    <td class="calculated"><span class="box-count">${prod.boxes}</span></td>
                    <td><input type="text" class="remarks" value="${prod.remarks}" placeholder="Optional"></td>
                    <td><button class="btn-danger action-btn" onclick="removeRow(${rowCounter})">‚úï</button></td>
                `;
                tbody.appendChild(newRow);
            });

            packingQueue.splice(index, 1);
            saveQueueToStorage();
            renderQueue();
            showAlert('Order loaded for editing', 'success');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteQueueItem(index) {
            if(confirm('Remove this order from queue?')) {
                packingQueue.splice(index, 1);
                saveQueueToStorage();
                renderQueue();
            }
        }

        function generateAllLabels() {
            if (packingQueue.length === 0) return;
            let totalGenerated = 0;
            packingQueue.forEach(order => {
                let boxNumber = 1;
                order.products.forEach(product => {
                    for (let i = 0; i < product.boxes; i++) {
                        const qtyInBox = (i === product.boxes - 1) ? product.totalQty - (i * product.qtyPerBox) : product.qtyPerBox;
                        boxRecords.push({
                            id: generateBoxId(),
                            orderNumber: order.orderNumber,
                            customerName: order.customerName,
                            deliveryLocation: order.deliveryLocation,
                            productName: product.productName,
                            boxNumber: boxNumber++,
                            totalBoxes: order.totalBoxes,
                            qtyInBox: qtyInBox,
                            lotNumber: '',
                            packingDate: order.packingDate,
                            remarks: product.remarks,
                            status: 'Pending Lot',
                            auditLogs: [],
                            deleted: false,
                            withdrawn: false,
                            withdrawalInfo: null,
                            workflowStatus: 'Orders Ready for Withdrawal',
                            itemStatus: 'Pending Stock Review',
                            stockAdjustedQty: qtyInBox,
                            stockAdjustedLot: '',
                            qcPassQty: 0,
                            qcFailQty: 0,
                            qcInspectedQty: 0,
                            reworkQty: 0,
                            finalApprovedQty: 0
                        });
                        totalGenerated++;
                    }
                });
            });
            packingQueue = [];
            saveQueueToStorage();
            saveRecordsToStorage();
            renderQueue();
            generateLabelPreviews();
            populateOrderNumberDropdown();
            showAlert(`Generated ${totalGenerated} labels!`, 'success');
            setTimeout(() => { document.querySelector('[onclick="switchTab(\'records\')"]').click(); }, 1000);
        }

        function clearFormInputs() {
            if(confirm('Clear form inputs? (Queue will remain)')) {
                document.getElementById('orderNumber').value = '';
                document.getElementById('customerName').value = '';
                resetProductTable();
            }
        }

        function generateBoxId() { 
            return 'BOX-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5).toUpperCase(); 
        }

        function generateLabelPreviews() {
            const container = document.getElementById('label-preview-container');
            const printContainer = document.getElementById('print-labels-container');
            container.innerHTML = ''; printContainer.innerHTML = '';
            
            const activeRecords = boxRecords.filter(r => !r.deleted).reverse().slice(0, 50);
            
            if (activeRecords.length === 0) {
                 document.getElementById('label-actions').style.display = 'none';
                 container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üè∑Ô∏è</div><div class="empty-state-text">No labels generated yet</div></div>`;
                 return;
            }
            document.getElementById('label-actions').style.display = 'flex';
            activeRecords.forEach(record => {
                container.appendChild(createLabelPreview(record));
                printContainer.appendChild(createPrintLabel(record));
            });
        }

        function createLabelPreview(record) {
            const hasMultipleLots = record.lotNumber && (record.lotNumber.includes('\n') || record.lotNumber.includes(','));
            const div = document.createElement('div');
            div.className = 'card'; div.style.marginBottom = '1rem';
            div.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:start;">
                    <div>
                        <div style="font-weight:700;font-size:1.2rem;color:var(--primary);">${record.productName}</div>
                        <div style="font-size:0.9rem;display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:0.5rem;">
                            <div>Order: ${record.orderNumber}</div>
                            <div>Box: ${record.boxNumber}/${record.totalBoxes}</div>
                            <div>Qty: ${record.qtyInBox}</div>
                            <div>LOT: ${hasMultipleLots ? 'üìö Mixed Lots' : (record.lotNumber||'-')}</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="printSingleLabel('${record.id}')">üñ®Ô∏è</button>
                </div>`;
            return div;
        }

        function createPrintLabel(record) {
            const lotText = record.lotNumber || '___________';
            const isMixedLot = lotText.includes('\n') || lotText.length > 20;
            const mixedLotClass = isMixedLot ? 'mixed-lot' : '';

            const div = document.createElement('div');
            div.className = 'print-label'; div.id = 'print-' + record.id;
            div.innerHTML = `
                <div class="label-header"><div class="label-title">PACKING & BOX LABEL</div></div>
                <div class="label-customer-highlight">${record.customerName}</div>
                <div class="label-info">
                    <div><strong>Order:</strong> ${record.orderNumber}<br><strong>Loc:</strong> ${record.deliveryLocation}</div>
                    <div><strong>Date:</strong> ${record.packingDate}<br><strong>ID:</strong> ${record.id}</div>
                </div>
                <div style="text-align:center;margin:2rem 0;font-size:2rem;font-weight:bold;">BOX ${record.boxNumber} / ${record.totalBoxes}</div>
                <div class="label-product"><div class="label-product-name">${record.productName}</div><div class="label-quantity">Qty: ${record.qtyInBox}</div></div>
                
                <div class="label-lot">
                    <div class="label-lot-title">LOT NUMBER:</div>
                    <div class="label-lot-content ${mixedLotClass}">${lotText}</div>
                </div>
                
                ${record.remarks ? `<div class="label-remarks"><strong>Remarks:</strong> ${record.remarks}</div>` : ''}
                <div class="label-signatures">
                    <div class="label-signature"><div style="height:3rem"></div>Packed by: _______</div>
                    <div class="label-signature"><div style="height:3rem"></div>Checked by: _______</div>
                </div>`;
            return div;
        }

        function printAllLabels() { window.print(); }
        function printSingleLabel(id) {
            document.querySelectorAll('.print-label').forEach(l => l.style.display = 'none');
            const t = document.getElementById('print-' + id);
            if(t) { t.style.display = 'block'; window.print(); t.style.display = 'none'; }
        }

        function groupRecordsByOrder(records) {
            const orders = {};
            records.forEach(r => {
                if (r.deleted) return;
                if (!orders[r.orderNumber]) {
                    orders[r.orderNumber] = {
                        orderNumber: r.orderNumber,
                        customerName: r.customerName,
                        packingDate: r.packingDate,
                        boxes: [],
                        totalBoxes: 0,
                        boxesWithLot: 0,
                        isLocked: true 
                    };
                }
                orders[r.orderNumber].boxes.push(r);
                orders[r.orderNumber].totalBoxes++;
                if (r.lotNumber) orders[r.orderNumber].boxesWithLot++;
                if (r.status !== 'QC Locked') orders[r.orderNumber].isLocked = false;
            });
            return Object.values(orders).sort((a,b) => new Date(b.packingDate) - new Date(a.packingDate));
        }

        function setFilter(type, el) {
            currentFilterType = type;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            if(type === 'today') document.getElementById('dateFilter').valueAsDate = new Date();
            else if (type === 'all') document.getElementById('dateFilter').value = '';
            renderOrderList();
        }

        function clearAllFilters() {
            document.getElementById('mainSearch').value = '';
            document.getElementById('dateFilter').value = '';
            setFilter('all', document.querySelector('.filter-chip:first-child'));
        }

        function renderOrderList() {
            const tbody = document.getElementById('orderListBody');
            const empty = document.getElementById('empty-history');
            tbody.innerHTML = '';

            let orders = groupRecordsByOrder(boxRecords);
            const search = document.getElementById('mainSearch').value.toLowerCase();
            const dateVal = document.getElementById('dateFilter').value;

            orders = orders.filter(o => {
                const textMatch = !search || o.orderNumber.toLowerCase().includes(search) || o.customerName.toLowerCase().includes(search) || o.boxes.some(b => b.productName.toLowerCase().includes(search));
                const dateMatch = !dateVal || o.packingDate === dateVal;
                let chipMatch = true;
                if (currentFilterType === 'incomplete') chipMatch = o.boxesWithLot < o.totalBoxes;
                if (currentFilterType === 'locked') chipMatch = o.isLocked;
                return textMatch && dateMatch && chipMatch;
            });

            updateStats();

            if (orders.length === 0) { empty.style.display = 'block'; return; }
            empty.style.display = 'none';

            orders.forEach(order => {
                const progress = Math.round((order.boxesWithLot / order.totalBoxes) * 100);
                const isFullyLocked = order.isLocked;
                const statusClass = isFullyLocked ? 'status-locked' : (progress === 100 ? 'status-packed' : 'status-updated');
                const statusText = isFullyLocked ? 'QC Locked' : (progress === 100 ? 'Completed' : 'In Progress');

                const tr = document.createElement('tr');
                tr.className = 'order-row';
                tr.onclick = (e) => { if(!e.target.closest('button')) toggleOrderDetails(order.orderNumber, tr); };
                tr.innerHTML = `
                    <td style="text-align:center; font-size:1.2rem;">‚ñ∂</td>
                    <td style="font-weight:700;">${order.orderNumber}</td>
                    <td>${order.customerName}</td>
                    <td>${order.packingDate}</td>
                    <td><div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div><small>${order.boxesWithLot}/${order.totalBoxes} LOTs</small></td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td><div class="action-btns"><button class="action-btn btn-secondary" onclick="generatePackingListPDFForOrder('${order.orderNumber}')">üìÑ List</button>${currentUserRole === 'supervisor' ? `<button class="action-btn btn-danger" onclick="deleteOrderByNumberDirect('${order.orderNumber}')">üóëÔ∏è All</button>` : ''}</div></td>
                `;
                tbody.appendChild(tr);

                const detailsTr = document.createElement('tr');
                detailsTr.id = `details-${order.orderNumber}`;
                detailsTr.className = 'order-details-row';
                let nestedHtml = `
                    <td colspan="7"><div style="padding: 1rem;"><strong style="margin-left: 1rem; color: var(--primary);">üì¶ Product Breakdown for ${order.orderNumber}:</strong>
                    <table class="nested-table"><thead><tr><th>Box ID</th><th>Product</th><th>Box #</th><th>Qty</th><th>LOT Number</th><th>Status</th><th>Action</th></tr></thead><tbody>
                `;
                order.boxes.sort((a,b) => a.boxNumber - b.boxNumber).forEach(box => {
                     const canEdit = currentUserRole === 'supervisor' || (currentUserRole !== 'packing' && box.status !== 'QC Locked') || (box.status === 'Pending Lot');
                     const isMixed = box.lotNumber && (box.lotNumber.includes('\n') || box.lotNumber.length > 20);
                     const hasLot = !!box.lotNumber;
                     
                     let actionBtn = '';
                     if (!canEdit) {
                         actionBtn = `<span style="color:#999">Locked</span>`;
                     } else if (!hasLot) {
                         actionBtn = `<button class="btn-sm btn-primary" onclick="openEditModal('${box.id}', 'assign')">üè∑Ô∏è Assign Lot</button>`;
                     } else {
                         actionBtn = `<button class="btn-sm btn-warning" onclick="openEditModal('${box.id}', 'retro')">‚úèÔ∏è Edit</button>`;
                     }

                     nestedHtml += `
                        <tr>
                            <td style="font-family:monospace;">${box.id.split('-').pop()}</td>
                            <td>${box.productName}</td>
                            <td>${box.boxNumber}</td>
                            <td>${box.qtyInBox}</td>
                            <td>${isMixed ? 'üìö Mixed Lots' : (box.lotNumber || '<span style="color:red">-</span>')}</td>
                            <td>${box.status}</td>
                            <td style="display:flex; gap:0.5rem;">
                                ${actionBtn}
                                <button class="btn-sm btn-secondary" onclick="printSingleLabel('${box.id}')">üñ®Ô∏è</button>
                            </td>
                        </tr>
                      `;
                });
                nestedHtml += `</tbody></table></div></td>`;
                detailsTr.innerHTML = nestedHtml;
                tbody.appendChild(detailsTr);
            });
        }

        function toggleOrderDetails(orderId, rowElement) {
            const detailsRow = document.getElementById(`details-${orderId}`);
            const isExpanded = detailsRow.classList.contains('active');
            document.querySelectorAll('.order-details-row').forEach(r => r.classList.remove('active'));
            document.querySelectorAll('.order-row').forEach(r => { r.classList.remove('expanded'); r.querySelector('td').textContent = '‚ñ∂'; });
            if (!isExpanded) { detailsRow.classList.add('active'); rowElement.classList.add('expanded'); rowElement.querySelector('td').textContent = '‚ñº'; }
        }

        function updateStats() {
            const todayStr = new Date().toISOString().split('T')[0];
            const activeRecs = boxRecords.filter(r => !r.deleted);
            document.getElementById('stat-total-orders').textContent = new Set(activeRecs.filter(r => r.packingDate === todayStr).map(r => r.orderNumber)).size;
            const orders = groupRecordsByOrder(activeRecs);
            const completed = orders.filter(o => o.isLocked).length;
            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-pending').textContent = orders.length - completed;
        }

        function deleteOrderByNumberDirect(orderNum) {
            deleteTarget = { type: 'order', orderNumber: orderNum };
            document.getElementById('deleteConfirmMessage').textContent = `Delete ALL boxes for Order ${orderNum}?`;
            document.getElementById('confirmDeleteModal').classList.add('active');
        }

        function generatePackingListPDFForOrder(orderNum) {
            document.getElementById('packingListOrderNumber').innerHTML = `<option value="${orderNum}">${orderNum}</option>`;
            document.getElementById('packingListOrderNumber').value = orderNum;
            document.querySelector('[onclick="switchTab(\'packing-list\')"]').click();
            setTimeout(() => generatePackingListPDF(), 500);
        }

        function openEditModal(id, type) {
            const r = boxRecords.find(x => x.id === id);
            if (!r) return;
            
            currentEditingBoxId = id;
            currentEditType = type;

            document.getElementById('editModalProductName').value = r.productName;
            document.getElementById('editModalQty').value = r.qtyInBox;
            document.getElementById('editModalLotNumber').value = r.lotNumber || '';
            document.getElementById('editModalRemarks').value = r.remarks || '';
            document.getElementById('editModalReason').value = '';

            const modalTitle = document.getElementById('editModalTitle');
            const warning = document.getElementById('retroactiveWarning');
            const reasonGroup = document.getElementById('editReasonGroup');

            if (type === 'assign') {
                modalTitle.textContent = "üè∑Ô∏è Assign LOT Number";
                modalTitle.style.color = "var(--primary)";
                warning.style.display = 'none';
                reasonGroup.style.display = 'none';
            } else {
                modalTitle.textContent = "‚úèÔ∏è Retroactive Edit";
                modalTitle.style.color = "var(--warning)";
                warning.style.display = 'block';
                reasonGroup.style.display = 'block';
            }

            document.getElementById('editBoxModal').classList.add('active');
        }

        function saveBoxEdit() {
            const r = boxRecords.find(x => x.id === currentEditingBoxId);
            if (!r) return;

            const newQty = parseInt(document.getElementById('editModalQty').value);
            const newLot = document.getElementById('editModalLotNumber').value;
            const newRemarks = document.getElementById('editModalRemarks').value;
            const reason = document.getElementById('editModalReason').value.trim();

            if (currentEditType === 'retro' && !reason) {
                alert("Please provide a Reason for this retroactive edit.");
                return;
            }

            if (currentEditType === 'retro') {
                if(!r.auditLogs) r.auditLogs = [];
                r.auditLogs.push({
                    date: new Date().toISOString(),
                    user: currentUserRole,
                    reason: reason,
                    changes: {
                        oldQty: r.qtyInBox, newQty: newQty,
                        oldLot: r.lotNumber, newLot: newLot
                    }
                });
            }

            r.qtyInBox = newQty;
            r.lotNumber = newLot;
            r.remarks = newRemarks;
            r.status = r.lotNumber ? 'Packed' : 'Pending Lot';
            
            saveRecordsToStorage();
            renderRecords();
            closeEditBoxModal();
            showAlert(currentEditType === 'assign' ? 'LOT Assigned!' : 'Record Updated!', 'success');
        }

        function confirmDelete() {
            if(deleteTarget.type === 'order') {
                boxRecords.forEach(r => { if(r.orderNumber === deleteTarget.orderNumber) r.deleted = true; });
            }
            saveRecordsToStorage(); renderRecords(); closeDeleteModal();
            showAlert('Deleted successfully', 'success');
        }

        function exportToExcel() {
            const active = boxRecords.filter(r => !r.deleted);
            if(!active.length) return showAlert('No records', 'error');
            let csv = "BoxID,Order,Customer,Location,Product,BoxNum,TotalBox,Qty,LOT,Date,Status\n";
            active.forEach(r => {
                const safeLot = (r.lotNumber||'').replace(/\n/g, ' | ');
                csv += `${r.id},${r.orderNumber},${r.customerName},${r.deliveryLocation},${r.productName},${r.boxNumber},${r.totalBoxes},${r.qtyInBox},"${safeLot}",${r.packingDate},${r.status}\n`;
            });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
            link.download = 'packing_records.csv';
            link.click();
        }

        function renderWithdrawalList() {
            const tbody = document.getElementById('withdrawalListBody');
            const empty = document.getElementById('empty-withdrawal');
            tbody.innerHTML = '';

            let orders = groupRecordsByOrder(boxRecords);
            orders = orders.filter(o => {
                const allHaveLot = o.boxes.every(b => b.lotNumber && b.lotNumber.trim() !== '');
                const notWithdrawn = o.boxes.every(b => !b.withdrawn);
                return allHaveLot && notWithdrawn;
            });

            const search = document.getElementById('withdrawalSearch').value.toLowerCase();
            const sortBy = document.getElementById('withdrawalSortBy').value;

            orders = orders.filter(o => 
                o.orderNumber.toLowerCase().includes(search) || 
                o.customerName.toLowerCase().includes(search)
            );

            orders.sort((a, b) => {
                if (sortBy === 'date-desc') return new Date(b.packingDate) - new Date(a.packingDate);
                if (sortBy === 'date-asc') return new Date(a.packingDate) - new Date(b.packingDate);
                if (sortBy === 'customer') return a.customerName.localeCompare(b.customerName);
                if (sortBy === 'boxes-desc') return b.totalBoxes - a.totalBoxes;
                return 0;
            });

            updateWithdrawalStats(orders);

            if (orders.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            orders.forEach(order => {
                const daysWaiting = Math.floor((new Date() - new Date(order.packingDate)) / (1000 * 60 * 60 * 24));
                const urgencyClass = daysWaiting > 7 ? 'status-locked' : (daysWaiting > 3 ? 'status-updated' : 'status-packed');

                const tr = document.createElement('tr');
                tr.className = 'order-row';
                tr.onclick = (e) => { if(!e.target.closest('button')) toggleOrderDetails(order.orderNumber, tr); };
                tr.innerHTML = `
                    <td style="text-align:center; font-size:1.2rem;">‚ñ∂</td>
                    <td style="font-weight:700;">${order.orderNumber}</td>
                    <td>${order.customerName}</td>
                    <td>${order.boxes[0].deliveryLocation}</td>
                    <td>${order.packingDate}</td>
                    <td style="text-align:center; font-weight:700;">${order.totalBoxes}</td>
                    <td style="text-align:center;"><span class="status-badge ${urgencyClass}">${daysWaiting} days</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn btn-success" onclick="openWithdrawalModal('${order.orderNumber}')">‚úÖ Withdraw</button>
                            <button class="action-btn btn-secondary" onclick="generatePackingListPDFForOrder('${order.orderNumber}')">üìÑ List</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);

                const detailsTr = document.createElement('tr');
                detailsTr.id = `details-${order.orderNumber}`;
                detailsTr.className = 'order-details-row';
                let nestedHtml = `
                    <td colspan="8"><div style="padding: 1rem;"><strong style="margin-left: 1rem; color: var(--primary);">üì¶ Boxes in this Order:</strong>
                    <table class="nested-table"><thead><tr><th>Box ID</th><th>Product</th><th>Box #</th><th>Qty</th><th>LOT Number</th><th>Actions</th></tr></thead><tbody>
                `;
                order.boxes.sort((a,b) => a.boxNumber - b.boxNumber).forEach(box => {
                    const isMixed = box.lotNumber && (box.lotNumber.includes('\n') || box.lotNumber.length > 20);
                    nestedHtml += `
                        <tr>
                            <td style="font-family:monospace;">${box.id.split('-').pop()}</td>
                            <td>${box.productName}</td>
                            <td>${box.boxNumber}</td>
                            <td>${box.qtyInBox}</td>
                            <td>${isMixed ? 'üìö Mixed Lots' : box.lotNumber}</td>
                            <td><button class="btn-sm btn-secondary" onclick="printSingleLabel('${box.id}')">üñ®Ô∏è Print</button></td>
                        </tr>
                    `;
                });
                nestedHtml += `</tbody></table></div></td>`;
                detailsTr.innerHTML = nestedHtml;
                tbody.appendChild(detailsTr);
            });
        }

        function updateWithdrawalStats(orders) {
            document.getElementById('stat-ready-orders').textContent = orders.length;
            const totalBoxes = orders.reduce((sum, o) => sum + o.totalBoxes, 0);
            document.getElementById('stat-ready-boxes').textContent = totalBoxes;
            
            if (orders.length > 0) {
                const oldestDate = new Date(Math.min(...orders.map(o => new Date(o.packingDate))));
                const oldestDays = Math.floor((new Date() - oldestDate) / (1000 * 60 * 60 * 24));
                document.getElementById('stat-oldest-days').textContent = oldestDays;
            } else {
                document.getElementById('stat-oldest-days').textContent = '0';
            }
        }

        function openWithdrawalModal(orderNumber) {
            currentWithdrawalOrder = orderNumber;
            const order = groupRecordsByOrder(boxRecords).find(o => o.orderNumber === orderNumber);
            if (!order) return;

            document.getElementById('withdrawalOrderInfo').innerHTML = `
                <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:0.5rem; font-size:0.9rem;">
                    <div><strong>Order:</strong> ${order.orderNumber}</div>
                    <div><strong>Customer:</strong> ${order.customerName}</div>
                    <div><strong>Total Boxes:</strong> ${order.totalBoxes}</div>
                    <div><strong>Packing Date:</strong> ${order.packingDate}</div>
                </div>
            `;

            const now = new Date();
            document.getElementById('withdrawalDate').valueAsDate = now;
            document.getElementById('withdrawalTime').value = now.toTimeString().slice(0,5);
            document.getElementById('withdrawnBy').value = '';
            document.getElementById('withdrawalNotes').value = '';

            document.getElementById('withdrawalModal').classList.add('active');
        }

        function closeWithdrawalModal() {
            document.getElementById('withdrawalModal').classList.remove('active');
            currentWithdrawalOrder = null;
        }

        function confirmWithdrawal() {
            const withdrawnBy = document.getElementById('withdrawnBy').value.trim();
            const withdrawalDate = document.getElementById('withdrawalDate').value;
            const withdrawalTime = document.getElementById('withdrawalTime').value;
            const notes = document.getElementById('withdrawalNotes').value.trim();

            if (!withdrawnBy || !withdrawalDate || !withdrawalTime) {
                alert('Please fill in all required fields (Name, Date, Time)');
                return;
            }

            boxRecords.forEach(r => {
                if (r.orderNumber === currentWithdrawalOrder && !r.deleted) {
                    r.withdrawn = true;
                    r.withdrawalInfo = {
                        withdrawnBy: withdrawnBy,
                        withdrawalDate: withdrawalDate,
                        withdrawalTime: withdrawalTime,
                        notes: notes,
                        timestamp: new Date().toISOString()
                    };
                    r.status = 'Withdrawn';
                }
            });

            saveRecordsToStorage();
            renderWithdrawalList();
            closeWithdrawalModal();
            showAlert(`Order ${currentWithdrawalOrder} marked as withdrawn!`, 'success');
        }

        function populateOrderNumberDropdown() {
            const sel = document.getElementById('packingListOrderNumber');
            const uniq = [...new Set(boxRecords.filter(r => !r.deleted).map(r => r.orderNumber))];
            sel.innerHTML = '<option value="">-- Select Order --</option>';
            uniq.forEach(o => { const opt = document.createElement('option'); opt.value = o; opt.textContent = o; sel.appendChild(opt); });
        }

        function generatePackingListPDF() {
            const ord = document.getElementById('packingListOrderNumber').value;
            if(!ord) return showAlert('Select Order', 'error');
            const recs = boxRecords.filter(r => !r.deleted && r.orderNumber === ord);
            if(!recs.length) return showAlert('No records', 'error');

            const grouped = {};
            recs.forEach(r => {
                if(!grouped[r.productName]) grouped[r.productName] = [];
                grouped[r.productName].push(r);
            });
            Object.keys(grouped).forEach(k => grouped[k].sort((a,b) => a.boxNumber - b.boxNumber));

            let html = `<div style="border:1px solid #ddd;padding:2rem;"><h3>PACKING LIST: ${ord}</h3><p>Customer: ${recs[0].customerName} | Date: ${recs[0].packingDate}</p><hr>`;
            Object.keys(grouped).forEach(sku => {
                html += `<h4>${sku}</h4><table style="width:100%;border-collapse:collapse;margin-bottom:1rem;"><tr><th style="border:1px solid #eee">Box</th><th style="border:1px solid #eee">Qty</th><th style="border:1px solid #eee">LOT</th></tr>`;
                grouped[sku].forEach(r => {
                    html += `<tr><td style="border:1px solid #eee;text-align:center">${r.boxNumber}/${r.totalBoxes}</td><td style="border:1px solid #eee;text-align:center">${r.qtyInBox}</td><td style="border:1px solid #eee;white-space:pre-wrap;">${r.lotNumber||'-'}</td></tr>`;
                });
                html += `</table>`;
            });
            html += `</div>`;
            document.getElementById('packing-list-content').innerHTML = html;
            document.getElementById('packing-list-preview').style.display = 'block';

            let printHtml = `<div class="packing-list-page"><div class="packing-list-print"><div class="packing-list-header"><h1 class="packing-list-title">PACKING LIST</h1><div class="packing-list-info"><div>Order: ${ord}</div><div>Customer: ${recs[0].customerName}</div><div>Date: ${recs[0].packingDate}</div></div></div>`;
            Object.keys(grouped).forEach(sku => {
                printHtml += `<div class="packing-list-sku-section"><div class="packing-list-sku-header">${sku}</div><table class="packing-list-table"><thead><tr><th>Box</th><th>ID</th><th>Qty</th><th>LOT</th></tr></thead><tbody>`;
                grouped[sku].forEach(r => {
                    printHtml += `<tr><td>${r.boxNumber}/${r.totalBoxes}</td><td>${r.id}</td><td>${r.qtyInBox}</td><td style="white-space:pre-wrap;">${r.lotNumber||'-'}</td></tr>`;
                });
                printHtml += `</tbody></table></div>`;
            });
            printHtml += `</div></div>`;
            document.getElementById('packing-list-print-container').innerHTML = printHtml;
        }

        function printPackingList() { window.print(); }

        function renderRecords() {
            renderOrderList();
            generateLabelPreviews();
        }

        function saveQueueToStorage() { localStorage.setItem('packingQueue', JSON.stringify(packingQueue)); }
        function saveRecordsToStorage() { localStorage.setItem('boxRecords', JSON.stringify(boxRecords)); }
        function loadRecordsFromStorage() {
            if(localStorage.getItem('boxRecords')) boxRecords = JSON.parse(localStorage.getItem('boxRecords'));
            if(localStorage.getItem('packingQueue')) packingQueue = JSON.parse(localStorage.getItem('packingQueue'));
        }

        function closeEditBoxModal() { document.getElementById('editBoxModal').classList.remove('active'); }
        function closeDeleteModal() { document.getElementById('confirmDeleteModal').classList.remove('active'); }
        
        function showAlert(msg, type) {
            const d = document.createElement('div');
            d.className = `alert alert-${type} active`; d.textContent = msg;
            document.getElementById('alert-container').appendChild(d);
            setTimeout(() => d.remove(), 3000);
        }

        // ========== NEW WORKFLOW FUNCTIONS ==========

        function updateBadgeCounts() {
            const withdrawalOrders = boxRecords.filter(r => !r.deleted && r.workflowStatus === 'Orders Ready for Withdrawal');
            const withdrawalCount = new Set(withdrawalOrders.map(r => r.orderNumber)).size;
            document.getElementById('withdrawal-badge').textContent = withdrawalCount;
            document.getElementById('withdrawal-badge').style.display = withdrawalCount > 0 ? 'inline-block' : 'none';

            const qcOrders = boxRecords.filter(r => !r.deleted && (r.workflowStatus === 'Waiting for QC Inspection' || r.workflowStatus === 'Partially QC Passed'));
            const qcCount = new Set(qcOrders.map(r => r.orderNumber)).size;
            document.getElementById('qc-badge').textContent = qcCount;
            document.getElementById('qc-badge').style.display = qcCount > 0 ? 'inline-block' : 'none';

            const reworkOrders = boxRecords.filter(r => !r.deleted && r.itemStatus === 'Returned to Stock');
            const reworkCount = new Set(reworkOrders.map(r => r.orderNumber)).size;
            document.getElementById('rework-badge').textContent = reworkCount;
            document.getElementById('rework-badge').style.display = reworkCount > 0 ? 'inline-block' : 'none';

            const shipOrders = boxRecords.filter(r => !r.deleted && r.workflowStatus === 'Ready to Ship');
            const shipCount = new Set(shipOrders.map(r => r.orderNumber)).size;
            document.getElementById('ship-badge').textContent = shipCount;
            document.getElementById('ship-badge').style.display = shipCount > 0 ? 'inline-block' : 'none';
        }

        function renderWithdrawalList() {
            const tbody = document.getElementById('withdrawalListBody');
            const empty = document.getElementById('empty-withdrawal');
            tbody.innerHTML = '';

            let orders = groupRecordsByOrder(boxRecords);
            orders = orders.filter(o => {
                return o.boxes.every(b => b.workflowStatus === 'Orders Ready for Withdrawal');
            });

            const search = document.getElementById('withdrawalSearch').value.toLowerCase();
            const sortBy = document.getElementById('withdrawalSortBy').value;

            orders = orders.filter(o => 
                o.orderNumber.toLowerCase().includes(search) || 
                o.customerName.toLowerCase().includes(search)
            );

            orders.sort((a, b) => {
                if (sortBy === 'date-desc') return new Date(b.packingDate) - new Date(a.packingDate);
                if (sortBy === 'date-asc') return new Date(a.packingDate) - new Date(b.packingDate);
                if (sortBy === 'customer') return a.customerName.localeCompare(b.customerName);
                if (sortBy === 'boxes-desc') return b.totalBoxes - a.totalBoxes;
                return 0;
            });

            updateWithdrawalStats(orders);
            updateBadgeCounts();

            if (orders.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            orders.forEach(order => {
                const daysWaiting = Math.floor((new Date() - new Date(order.packingDate)) / (1000 * 60 * 60 * 24));
                const urgencyClass = daysWaiting > 7 ? 'status-locked' : (daysWaiting > 3 ? 'status-updated' : 'status-packed');

                const tr = document.createElement('tr');
                tr.className = 'order-row';
                tr.onclick = (e) => { if(!e.target.closest('button')) toggleOrderDetails(order.orderNumber, tr); };
                tr.innerHTML = `
                    <td style="text-align:center; font-size:1.2rem;">‚ñ∂</td>
                    <td style="font-weight:700;">${order.orderNumber}</td>
                    <td>${order.customerName}</td>
                    <td>${order.boxes[0].deliveryLocation}</td>
                    <td>${order.packingDate}</td>
                    <td style="text-align:center; font-weight:700;">${order.totalBoxes}</td>
                    <td style="text-align:center;"><span class="status-badge ${urgencyClass}">${daysWaiting} days</span></td>
                    <td><span class="status-badge status-updated">Ready for Stock</span></td>
                    <td>
                        <div class="action-btns">
                            ${currentUserRole === 'store' || currentUserRole === 'supervisor' ? `<button class="action-btn btn-primary" onclick="openStockEditModal('${order.orderNumber}')">üì¶ Stock Review</button>` : ''}
                            <button class="action-btn btn-secondary" onclick="generatePackingListPDFForOrder('${order.orderNumber}')">üìÑ List</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);

                const detailsTr = document.createElement('tr');
                detailsTr.id = `details-${order.orderNumber}`;
                detailsTr.className = 'order-details-row';
                let nestedHtml = `
                    <td colspan="9"><div style="padding: 1rem;"><strong style="margin-left: 1rem; color: var(--primary);">üì¶ Items in this Order:</strong>
                    <table class="nested-table"><thead><tr><th>Box ID</th><th>Product</th><th>Box #</th><th>Qty</th><th>LOT</th><th>Item Status</th></tr></thead><tbody>
                `;
                order.boxes.sort((a,b) => a.boxNumber - b.boxNumber).forEach(box => {
                    nestedHtml += `
                        <tr>
                            <td style="font-family:monospace;">${box.id.split('-').pop()}</td>
                            <td>${box.productName}</td>
                            <td>${box.boxNumber}</td>
                            <td>${box.qtyInBox}</td>
                            <td>${box.lotNumber || '-'}</td>
                            <td><span class="status-badge status-updated">${box.itemStatus}</span></td>
                        </tr>
                    `;
                });
                nestedHtml += `</tbody></table></div></td>`;
                detailsTr.innerHTML = nestedHtml;
                tbody.appendChild(detailsTr);
            });
        }

        function openStockEditModal(orderNumber) {
            if (currentUserRole !== 'store' && currentUserRole !== 'supervisor') {
                alert('Only Stock staff can perform this action');
                return;
            }

            currentStockEditOrder = orderNumber;
            const boxes = boxRecords.filter(r => r.orderNumber === orderNumber && !r.deleted);
            
            document.getElementById('stockEditOrderInfo').innerHTML = `
                <div><strong>Order:</strong> ${orderNumber} | <strong>Customer:</strong> ${boxes[0].customerName}</div>
            `;

            let itemsHTML = '<div style="display:flex; flex-direction:column; gap:1rem;">';
            boxes.forEach((box, idx) => {
                itemsHTML += `
                    <div style="border:1px solid #ddd; padding:1rem; border-radius:8px;">
                        <div style="font-weight:600; margin-bottom:0.5rem;">${box.productName} - Box ${box.boxNumber}</div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                            <div class="form-group">
                                <label>LOT Number *</label>
                                <input type="text" id="stock-lot-${idx}" value="${box.lotNumber || box.stockAdjustedLot}" style="padding:0.5rem; border:2px solid var(--border); border-radius:6px; width:100%;">
                            </div>
                            <div class="form-group">
                                <label>Quantity *</label>
                                <input type="number" id="stock-qty-${idx}" value="${box.stockAdjustedQty}" min="1" style="padding:0.5rem; border:2px solid var(--border); border-radius:6px; width:100%;">
                            </div>
                        </div>
                    </div>
                `;
            });
            itemsHTML += '</div>';
            document.getElementById('stockEditItems').innerHTML = itemsHTML;
            document.getElementById('stockEditModal').classList.add('active');
        }

        function closeStockEditModal() {
            document.getElementById('stockEditModal').classList.remove('active');
            currentStockEditOrder = null;
        }

        function submitStockAdjustment() {
            const boxes = boxRecords.filter(r => r.orderNumber === currentStockEditOrder && !r.deleted);
            
            boxes.forEach((box, idx) => {
                const lot = document.getElementById(`stock-lot-${idx}`).value.trim();
                const qty = parseInt(document.getElementById(`stock-qty-${idx}`).value);

                if (!lot || qty <= 0) {
                    alert(`Please fill all fields for ${box.productName}`);
                    return;
                }

                box.stockAdjustedLot = lot;
                box.stockAdjustedQty = qty;
                box.lotNumber = lot;
                box.qtyInBox = qty;
                box.workflowStatus = 'Waiting for QC Inspection';
                box.itemStatus = 'QC Pending';
            });

            saveRecordsToStorage();
            closeStockEditModal();
            renderWithdrawalList();
            showAlert('Stock adjustment completed. Order sent to QC!', 'success');
        }

        function renderQCInspectionList() {
            const tbody = document.getElementById('qcListBody');
            const empty = document.getElementById('empty-qc');
            tbody.innerHTML = '';

            let orders = groupRecordsByOrder(boxRecords);
            orders = orders.filter(o => {
                return o.boxes.some(b => b.workflowStatus === 'Waiting for QC Inspection' || b.workflowStatus === 'Partially QC Passed');
            });

            updateBadgeCounts();

            if (orders.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            orders.forEach(order => {
                const tr = document.createElement('tr');
                tr.className = 'order-row';
                tr.onclick = (e) => { if(!e.target.closest('button')) toggleOrderDetails(order.orderNumber, tr); };
                
                const statusClass = order.boxes.every(b => b.qcPassQty > 0) ? 'status-packed' : 'status-updated';
                const statusText = order.boxes.every(b => b.qcPassQty > 0) ? 'Partially Passed' : 'QC Pending';
                
                tr.innerHTML = `
                    <td style="text-align:center;">‚ñ∂</td>
                    <td style="font-weight:700;">${order.orderNumber}</td>
                    <td>${order.customerName}</td>
                    <td style="text-align:center;">${order.totalBoxes}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        ${currentUserRole === 'qc' || currentUserRole === 'supervisor' ? `<button class="action-btn btn-primary" onclick="openQCInspectionModal('${order.orderNumber}')">üîç Inspect</button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);

                const detailsTr = document.createElement('tr');
                detailsTr.id = `details-${order.orderNumber}`;
                detailsTr.className = 'order-details-row';
                let nestedHtml = `<td colspan="6"><div style="padding:1rem;"><table class="nested-table"><thead><tr><th>Product</th><th>Stock Qty</th><th>QC Pass</th><th>QC Fail</th><th>Status</th></tr></thead><tbody>`;
                
                order.boxes.forEach(box => {
                    nestedHtml += `
                        <tr>
                            <td>${box.productName}</td>
                            <td>${box.stockAdjustedQty}</td>
                            <td>${box.qcPassQty}</td>
                            <td>${box.qcFailQty}</td>
                            <td><span class="status-badge status-updated">${box.itemStatus}</span></td>
                        </tr>
                    `;
                });
                nestedHtml += `</tbody></table></div></td>`;
                detailsTr.innerHTML = nestedHtml;
                tbody.appendChild(detailsTr);
            });

            document.getElementById('stat-qc-pending').textContent = orders.length;
            const passed = boxRecords.filter(r => !r.deleted && r.qcPassQty > 0).length;
            document.getElementById('stat-qc-passed').textContent = passed;
            const failed = boxRecords.filter(r => !r.deleted && r.qcFailQty > 0).length;
            document.getElementById('stat-qc-failed').textContent = failed;
        }

        function openQCInspectionModal(orderNumber) {
            if (currentUserRole !== 'qc' && currentUserRole !== 'supervisor') {
                alert('Only QC staff can perform this action');
                return;
            }

            currentQCInspectionOrder = orderNumber;
            const boxes = boxRecords.filter(r => r.orderNumber === orderNumber && !r.deleted && (r.workflowStatus === 'Waiting for QC Inspection' || r.workflowStatus === 'Partially QC Passed'));
            
            document.getElementById('qcInspectionOrderInfo').innerHTML = `
                <div><strong>Order:</strong> ${orderNumber} | <strong>Customer:</strong> ${boxes[0].customerName}</div>
            `;

            let itemsHTML = '<div style="display:flex; flex-direction:column; gap:1rem;">';
            boxes.forEach((box, idx) => {
                itemsHTML += `
                    <div style="border:1px solid #ddd; padding:1rem; border-radius:8px;">
                        <div style="font-weight:600; margin-bottom:0.5rem;">${box.productName} - Box ${box.boxNumber}</div>
                        <div style="margin-bottom:0.5rem;"><strong>LOT:</strong> ${box.stockAdjustedLot} | <strong>Stock Qty:</strong> ${box.stockAdjustedQty}</div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                            <div class="form-group">
                                <label style="color:var(--success);">QC Pass Quantity *</label>
                                <input type="number" id="qc-pass-${idx}" value="${box.qcPassQty}" min="0" max="${box.stockAdjustedQty}" style="padding:0.5rem; border:2px solid var(--success); border-radius:6px; width:100%;" onchange="validateQCQty(${idx}, ${box.stockAdjustedQty})">
                            </div>
                            <div class="form-group">
                                <label style="color:var(--danger);">QC Fail Quantity *</label>
                                <input type="number" id="qc-fail-${idx}" value="${box.qcFailQty}" min="0" max="${box.stockAdjustedQty}" style="padding:0.5rem; border:2px solid var(--danger); border-radius:6px; width:100%;" onchange="validateQCQty(${idx}, ${box.stockAdjustedQty})">
                            </div>
                        </div>
                        <small id="qc-error-${idx}" style="color:var(--danger); display:none;">Pass + Fail cannot exceed Stock Qty!</small>
                    </div>
                `;
            });
            itemsHTML += '</div>';
            document.getElementById('qcInspectionItems').innerHTML = itemsHTML;
            document.getElementById('qcInspectionModal').classList.add('active');
        }

        function validateQCQty(idx, maxQty) {
            const passQty = parseInt(document.getElementById(`qc-pass-${idx}`).value) || 0;
            const failQty = parseInt(document.getElementById(`qc-fail-${idx}`).value) || 0;
            const errorEl = document.getElementById(`qc-error-${idx}`);

            if (passQty + failQty > maxQty) {
                errorEl.style.display = 'block';
                return false;
            } else {
                errorEl.style.display = 'none';
                return true;
            }
        }

        function closeQCInspectionModal() {
            document.getElementById('qcInspectionModal').classList.remove('active');
            currentQCInspectionOrder = null;
        }

        function submitQCInspection() {
            const boxes = boxRecords.filter(r => r.orderNumber === currentQCInspectionOrder && !r.deleted && (r.workflowStatus === 'Waiting for QC Inspection' || r.workflowStatus === 'Partially QC Passed'));
            
            let allValid = true;
            boxes.forEach((box, idx) => {
                if (!validateQCQty(idx, box.stockAdjustedQty)) {
                    allValid = false;
                }
            });

            if (!allValid) {
                alert('Please fix validation errors before submitting');
                return;
            }

            boxes.forEach((box, idx) => {
                const passQty = parseInt(document.getElementById(`qc-pass-${idx}`).value) || 0;
                const failQty = parseInt(document.getElementById(`qc-fail-${idx}`).value) || 0;

                box.qcPassQty = passQty;
                box.qcFailQty = failQty;
                box.qcInspectedQty = passQty + failQty;
                box.finalApprovedQty = passQty;

                if (failQty > 0) {
                    box.itemStatus = 'Returned to Stock';
                    box.reworkQty = failQty;
                    box.workflowStatus = 'Partially QC Passed';
                } else if (passQty > 0) {
                    box.itemStatus = 'QC Pass';
                }
            });

            const allPassed = boxes.every(b => b.qcFailQty === 0 && b.qcPassQty > 0);
            boxes.forEach(box => {
                if (allPassed) {
                    box.workflowStatus = 'Ready to Ship';
                }
            });

            saveRecordsToStorage();
            closeQCInspectionModal();
            renderQCInspectionList();
            if (allPassed) {
                showAlert('QC Passed! Order is ready to ship.', 'success');
            } else {
                showAlert('QC Completed. Failed items sent to Stock for rework.', 'warning');
            }
        }

        function renderStockReworkList() {
            const tbody = document.getElementById('reworkListBody');
            const empty = document.getElementById('empty-rework');
            tbody.innerHTML = '';

            let orders = groupRecordsByOrder(boxRecords);
            orders = orders.filter(o => {
                return o.boxes.some(b => b.itemStatus === 'Returned to Stock' && b.reworkQty > 0);
            });

            updateBadgeCounts();

            if (orders.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            orders.forEach(order => {
                const failedItems = order.boxes.filter(b => b.itemStatus === 'Returned to Stock').length;
                const tr = document.createElement('tr');
                tr.className = 'order-row';
                tr.onclick = (e) => { if(!e.target.closest('button')) toggleOrderDetails(order.orderNumber, tr); };
                
                tr.innerHTML = `
                    <td style="text-align:center;">‚ñ∂</td>
                    <td style="font-weight:700;">${order.orderNumber}</td>
                    <td>${order.customerName}</td>
                    <td style="text-align:center; color:var(--danger); font-weight:600;">${failedItems}</td>
                    <td>
                        ${currentUserRole === 'store' || currentUserRole === 'supervisor' ? `<button class="action-btn btn-warning" onclick="openReworkModal('${order.orderNumber}')">üîß Rework</button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);

                const detailsTr = document.createElement('tr');
                detailsTr.id = `details-${order.orderNumber}`;
                detailsTr.className = 'order-details-row';
                let nestedHtml = `<td colspan="5"><div style="padding:1rem;"><table class="nested-table"><thead><tr><th>Product</th><th>Failed Qty</th><th>LOT</th><th>Status</th></tr></thead><tbody>`;
                
                order.boxes.filter(b => b.itemStatus === 'Returned to Stock').forEach(box => {
                    nestedHtml += `
                        <tr>
                            <td>${box.productName}</td>
                            <td style="color:var(--danger); font-weight:600;">${box.reworkQty}</td>
                            <td>${box.stockAdjustedLot}</td>
                            <td><span class="status-badge status-locked">Needs Rework</span></td>
                        </tr>
                    `;
                });
                nestedHtml += `</tbody></table></div></td>`;
                detailsTr.innerHTML = nestedHtml;
                tbody.appendChild(detailsTr);
            });
        }

        function openReworkModal(orderNumber) {
            if (currentUserRole !== 'store' && currentUserRole !== 'supervisor') {
                alert('Only Stock staff can perform this action');
                return;
            }

            currentReworkOrder = orderNumber;
            const boxes = boxRecords.filter(r => r.orderNumber === orderNumber && !r.deleted && r.itemStatus === 'Returned to Stock');
            
            document.getElementById('reworkOrderInfo').innerHTML = `
                <div><strong>Order:</strong> ${orderNumber} | <strong>Customer:</strong> ${boxes[0].customerName}</div>
            `;

            let itemsHTML = '<div style="display:flex; flex-direction:column; gap:1rem;">';
            boxes.forEach((box, idx) => {
                itemsHTML += `
                    <div style="border:1px solid var(--danger); padding:1rem; border-radius:8px; background:#fff5f5;">
                        <div style="font-weight:600; margin-bottom:0.5rem; color:var(--danger);">‚ùå ${box.productName} - Box ${box.boxNumber}</div>
                        <div style="margin-bottom:0.5rem;"><strong>Failed Qty:</strong> ${box.reworkQty}</div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                            <div class="form-group">
                                <label>New LOT Number *</label>
                                <input type="text" id="rework-lot-${idx}" value="${box.stockAdjustedLot}" style="padding:0.5rem; border:2px solid var(--border); border-radius:6px; width:100%;">
                            </div>
                            <div class="form-group">
                                <label>Corrected Quantity *</label>
                                <input type="number" id="rework-qty-${idx}" value="${box.reworkQty}" min="1" max="${box.reworkQty}" style="padding:0.5rem; border:2px solid var(--border); border-radius:6px; width:100%;">
                            </div>
                        </div>
                    </div>
                `;
            });
            itemsHTML += '</div>';
            document.getElementById('reworkItems').innerHTML = itemsHTML;
            document.getElementById('stockReworkModal').classList.add('active');
        }

        function closeReworkModal() {
            document.getElementById('stockReworkModal').classList.remove('active');
            currentReworkOrder = null;
        }

        function submitRework() {
            const boxes = boxRecords.filter(r => r.orderNumber === currentReworkOrder && !r.deleted && r.itemStatus === 'Returned to Stock');
            
            boxes.forEach((box, idx) => {
                const lot = document.getElementById(`rework-lot-${idx}`).value.trim();
                const qty = parseInt(document.getElementById(`rework-qty-${idx}`).value);

                if (!lot || qty <= 0) {
                    alert(`Please fill all fields for ${box.productName}`);
                    return;
                }

                box.stockAdjustedLot = lot;
                box.stockAdjustedQty = qty;
                box.lotNumber = lot;
                box.reworkQty = 0;
                box.qcPassQty = 0;
                box.qcFailQty = 0;
                box.workflowStatus = 'Waiting for QC Inspection';
                box.itemStatus = 'QC Pending';
            });

            saveRecordsToStorage();
            closeReworkModal();
            renderStockReworkList();
            showAlert('Rework completed. Items sent back to QC for re-inspection.', 'success');
        }

        function renderReadyToShipList() {
            const tbody = document.getElementById('shipListBody');
            const empty = document.getElementById('empty-ship');
            tbody.innerHTML = '';

            let orders = groupRecordsByOrder(boxRecords);
            orders = orders.filter(o => {
                return o.boxes.every(b => b.workflowStatus === 'Ready to Ship' && b.finalApprovedQty > 0);
            });

            updateBadgeCounts();

            if (orders.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            orders.forEach(order => {
                const tr = document.createElement('tr');
                tr.className = 'order-row';
                tr.onclick = (e) => { if(!e.target.closest('button')) toggleOrderDetails(order.orderNumber, tr); };
                
                tr.innerHTML = `
                    <td style="text-align:center;">‚ñ∂</td>
                    <td style="font-weight:700;">${order.orderNumber}</td>
                    <td>${order.customerName}</td>
                    <td style="text-align:center;">${order.totalBoxes}</td>
                    <td>${order.packingDate}</td>
                    <td>
                        <button class="action-btn btn-success" onclick="shipOrder('${order.orderNumber}')">üöö Ship Now</button>
                        <button class="action-btn btn-secondary" onclick="generatePackingListPDFForOrder('${order.orderNumber}')">üìÑ List</button>
                    </td>
                `;
                tbody.appendChild(tr);

                const detailsTr = document.createElement('tr');
                detailsTr.id = `details-${order.orderNumber}`;
                detailsTr.className = 'order-details-row';
                let nestedHtml = `<td colspan="6"><div style="padding:1rem;"><table class="nested-table"><thead><tr><th>Product</th><th>Approved Qty</th><th>LOT</th><th>Status</th></tr></thead><tbody>`;
                
                order.boxes.forEach(box => {
                    nestedHtml += `
                        <tr>
                            <td>${box.productName}</td>
                            <td style="color:var(--success); font-weight:600;">${box.finalApprovedQty}</td>
                            <td>${box.stockAdjustedLot}</td>
                            <td><span class="status-badge status-packed">‚úÖ Ready</span></td>
                        </tr>
                    `;
                });
                nestedHtml += `</tbody></table></div></td>`;
                detailsTr.innerHTML = nestedHtml;
                tbody.appendChild(detailsTr);
            });
        }

        function shipOrder(orderNumber) {
            if (confirm(`Ship order ${orderNumber} to customer?`)) {
                boxRecords.forEach(r => {
                    if (r.orderNumber === orderNumber && !r.deleted && r.workflowStatus === 'Ready to Ship') {
                        r.workflowStatus = 'Shipped';
                        r.itemStatus = 'Shipped';
                        r.shippedDate = new Date().toISOString();
                    }
                });
                saveRecordsToStorage();
                renderReadyToShipList();
                showAlert(`Order ${orderNumber} has been shipped!`, 'success');
            }
        }
    </script>
</body>
</html>